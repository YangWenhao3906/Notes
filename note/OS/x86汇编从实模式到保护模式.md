# 环境配置

## Virtual Box虚拟机

采用作者给的VHD格式虚拟磁盘

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121204534898.png" alt="image-20220121204534898" style="zoom: 50%;" />

## NASM

下载32位版本

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121204000326.png" alt="image-20220121204000326" style="zoom: 33%;" />

## 汇编编辑器Nasmide

图书配套工具

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121204433429.png" alt="image-20220121204433429" style="zoom: 33%;" />

### 编译失败

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121205349358.png" alt="image-20220121205349358" style="zoom:67%;" />

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121205406623.png" alt="image-20220121205406623" style="zoom:67%;" />

改成mov word成功

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121211253823.png" alt="image-20220121211253823" style="zoom: 67%;" />

### 起始扇区代码未执行

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121212038898.png" alt="image-20220121212038898" style="zoom: 50%;" />

写入起始扇区,十分奇怪,没有按照原本的样子,应在屏幕上显示a、s、m三个字母

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220121212027185.png" alt="image-20220121212027185" style="zoom: 50%;" />

下载书本对应版本,或AMD CPU不支持?

#### 更改NASM版本

更改版本为图书出版时的2.07,还是不行

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122155603672.png" alt="image-20220122155603672" style="zoom: 33%;" />

#### 自己创建VHD

不使用作者给的VHD,自己从头创建VHD硬盘,还是不行

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122160629605.png" alt="image-20220122160629605" style="zoom:50%;" />

使用作者的VHD,什么都不动,输出`Protect mode OK`

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122170810650.png" alt="image-20220122170810650" style="zoom: 50%;" />

查看Hex

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122171149134.png" alt="image-20220122171149134" style="zoom: 50%;" />

写入

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122170916392.png" alt="image-20220122170916392" style="zoom:50%;" />

查看写入后的Hex

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122171606175.png" alt="image-20220122171606175" style="zoom:50%;" />

很奇怪,为黑屏

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122170950586.png" alt="image-20220122170950586" style="zoom: 33%;" />

原来是汇编代码写的有问题

改成mov byte即可

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122180637355.png" alt="image-20220122180637355" style="zoom: 50%;" />

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220122180607503.png" alt="image-20220122180607503" style="zoom: 50%;" />

# 编写主引导扇区代码

## bochs环境配置

运行bochs

第一次运行成功, 然后直接关闭console界面, 

第二次运行失败

<img src="images/x86%E6%B1%87%E7%BC%96%E4%BB%8E%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/image-20220124193433961.png" alt="image-20220124193433961" style="zoom: 67%;" />

经检索, 属于不正常退出, 在硬盘所在目录产生了.lock文件

删除.lock文件后可以运行

之后关闭要点Power off

